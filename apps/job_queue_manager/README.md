# Drizzle ORM + GraphQL + Cloudflare D1

This project sets up a GraphQL server using Drizzle ORM with a Cloudflare D1 database backend.

## Catalyst Job-Queue Service

This worker acts as the **general-purpose Job Queue for the Catalyst platform**.  
It lets any Catalyst service or external consumer:

1. **Enqueue a job** via the GraphQL `insertIntoJobsSingle` mutation (or its bulk variants). Each job row is written to D1 and a JSON `{ jobId }` message is pushed onto the Cloudflare **`JOB_QUEUE`** so workers can pick it up for execution.
2. **Update job lifecycle fields** â€“ only the following columns are user-mutable to keep the data model consistent:
    - `status`
    - `resultBucket`
    - `dataChannelId`
    - `parameters` (arbitrary JSON string storing run-time config)
3. **Query results** with the autogenerated GraphQL queries (e.g. `jobsCollection`). The job record exposes the final status and any result-location metadata so clients can fetch artefacts directly in Catalyst.

Under the hood the worker uses **Drizzle ORM**, **drizzle-graphql** and **Cloudflare D1** for storage, plus a Cloudflare **Queue** for event fan-out.

---

## Setup (local development)

1. Install dependencies:

```bash
pnpm install
```

2. Create a D1 database. You can do this locally for development.

```bash
wrangler d1 create jobs-db
```

This will output a `database_id`. Update `wrangler.toml` with this ID. For the `preview_database_id`, you can create another one or reuse the same one for simplicity in local development.

3. Apply the database schema (writes to the SQLite file Miniflare will use):

```bash
pnpm run db:push
```

4. Run the development server (Miniflare + D1):

```bash
pnpm run dev
```

The GraphQL endpoint will be available at `http://localhost:8787/graphql`. You can use a tool like GraphiQL to interact with it.

### Quick example

```graphql
mutation {
  insertIntoJobsSingle(values: { jobId: "demo-1", parameters: "{\\"foo\\":\\"bar\\"}" }) {
    jobId status submittedTimestamp
  }
}
```

See the Vitest specs in `apps/job_queue_manager/tests` for programmatic examples of enqueuing a job and verifying that a Queue message is produced.
